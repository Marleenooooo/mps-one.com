import React, { createContext, useContext, useEffect, useMemo, useState } from 'react';
import { getGeoInfo } from '../services/geo';
import { getPreferredLanguage, setPreferredLanguage } from '../services/i18n';

export type Language = 'en' | 'id';

type I18nContextValue = {
  language: Language;
  setLanguage: (lang: Language) => void;
  t: (key: string) => string;
};

const translations: Record<Language, Record<string, string>> = {
  en: {
    // Auth / Login
    'auth.login_title': 'Sign in to MPSOne',
    'auth.login_subtitle': 'Enterprise procurement suite for Kalimantan mining companies',
    'auth.email': 'Email',
    'auth.password': 'Password',
    'auth.password_placeholder': 'Enter your password',
    'auth.remember_me': 'Remember me',
    'auth.forgot_password': 'Forgot password?',
    'auth.role': 'Sign in as',
    'auth.role_hint': 'Role-based permissions: Admin, PIC Operational, PIC Procurement, PIC Finance',
    'auth.sign_in': 'Sign In',
    'auth.or': 'or',
    'auth.sso': 'Sign in with SSO',
    'auth.sso_hint': 'SSO integration placeholder (Azure AD / Google Workspace)',
    'auth.security_notice': 'Security: WCAG AA, secure forms, and protected routes',
    'auth.version': 'Version {v}',
    'auth.login_success': 'Welcome {email}',
    'auth.error_email': 'Please enter a valid email address',
    'auth.error_password': 'Password must be at least 6 characters',
    'auth.choose_who': 'Who are you?',
    'auth.i_am_supplier': 'I am a Supplier',
    'auth.i_am_client': 'I am a Client',
    'auth.role_explain': 'Suppliers sign in as Admin. Clients choose a PIC role.',
    'auth.mode_supplier': 'Supplier mode selected',
    'auth.mode_client': 'Client mode selected',
    'auth.supplier_admin_assumed': 'Supplier Admin access assumed for this environment',
    'auth.use_code': 'Sign in with Code',
    'auth.join_with_code_hint': 'Enter the access code provided by your admin to auto-configure your account.',
    'auth.code_invalid': 'Invalid code',
    'auth.code_success': 'Access granted',
    'auth.code_number': 'Code number',
    'auth.continue': 'Continue',
    'department.name': 'Department',
    'clipboard.copied': 'Copied',

    // Role descriptions
    'roles.pic_operational_desc': 'Daily receiving, delivery confirmation, delivery letter corrections.',
    'roles.pic_procurement_desc': 'PR creation, supplier quotes, PO generation, vendor coordination.',
    'roles.pic_finance_desc': 'Invoice verification, payment scheduling, payment status tracking.',

    // Admin invites
    'admin.invite_user': 'Invite User',
    'admin.invites.title': 'Manage Invites',
    'admin.invites.none': 'No invites yet.',
    'admin.invites.code': 'Code',
    'admin.invites.expires_at': 'Expires At',
    'admin.invites.status': 'Status',
    'admin.invites.revoke': 'Revoke',
    // General
    'general.home': 'Home',

    // Navigation
    'nav.admin_dashboard': 'Admin Dashboard',
    'nav.client_dashboard': 'Client Dashboard',
    'nav.onboarding': 'Corporate Onboarding',
    'nav.purchase_requests': 'Purchase Requests',
    'nav.quote_builder': 'Quote Builder',
    'nav.order_tracker': 'Order Tracker',
    'nav.docs': 'Document Manager',
    'nav.comms': 'Communication Hub',
    'nav.email_dashboard': 'Email Dashboard',
    'nav.reporting': 'Reporting',
    'nav.help': 'Help Center',
    'nav.people': 'People',
    'nav.invitations': 'Invitations',

    // Topbar
    'topbar.light': 'Light',
    'topbar.dark': 'Dark',
    'topbar.neon': 'Neon',
    'topbar.mode': 'Mode',
    'topbar.theme': 'Theme',
    'topbar.quick_search': 'Search PRs, POs, quotes...',
    'topbar.notifications': 'Notifications',
    'topbar.unread': 'unread',
    'topbar.language': 'Language',
    'topbar.lang.en': 'English',
    'topbar.lang.id': 'Bahasa Indonesia',
    'topbar.help': 'Help',
    'topbar.theme_toggle': 'Toggle theme',
    'topbar.language_toggle': 'Toggle language',
    'topbar.settings': 'Settings',
    'topbar.logout': 'Logout',
    'topbar.logged_in_as': 'Logged in as {name}',
    'topbar.offline_mock': 'Offline Mock',

    // Admin Dashboard
    'admin.title': 'Admin Dashboard',
    'admin.metrics.pending_quotes': 'Pending Quotes',
    'admin.metrics.active_pos': 'Active POs',
    'admin.metrics.unpaid_invoices': 'Unpaid Invoices',
    'admin.updated_hint': 'Updated 10m ago',
    'admin.comm_center': 'Client Communication Center',
    'admin.compose_email': 'Compose Email',
    'admin.recent_activity': 'Recent Activity',
    'admin.new_pr': 'New PR',
    'admin.new_quote': 'New Quote',
    'admin.new_po': 'New PO',

    // Activity strings
    'activity.created_quote': 'Created Quote {id} for {pr}',
    'activity.approved_po': 'Approved {po}',
    'activity.updated_budget': 'Updated budget for {dept}',

    // Time strings
    'time.today': 'Today',
    'time.yesterday': 'Yesterday',
    'time.hours_ago': '{n}h ago',
    'time.days_ago': '{n}d ago',

    // DataTable common
    'datatable.filter': 'Filter...',
    'datatable.export_csv': 'Export CSV',
    'datatable.export_pdf': 'Export PDF',
    'datatable.client_id': 'Client ID',
    'datatable.company': 'Company',
    'datatable.status': 'Status',
    'datatable.last_contact': 'Last Contact',
    'datatable.bulk_action': 'Bulk Action',
    'datatable.select_all': 'Select all',
    'datatable.prev': 'Prev',
    'datatable.next': 'Next',
    'datatable.page': 'Page',

    // Status values
    'status.active': 'Active',
    'status.pending_quote': 'Pending Quote',
    'status.po_issued': 'PO Issued',
    'status.shipped': 'Shipped',
    'status.unpaid': 'Unpaid',
    'status.processing': 'Processing',
    'status.delivered': 'Delivered',
    'status.invoiced': 'Invoiced',
    'status.paid': 'Paid',
    'status.pr': 'PR',
    'status.quote': 'Quote',
    'status.po': 'PO',

    // Client Dashboard
    'client.quick_pr': 'Quick PR',
    'client.quick_pr_desc': 'Create a purchase request with a few clicks.',
    'client.create_pr': 'Create PR',
    'client.budget_utilization': 'Budget Utilization',
    'client.documents': 'Documents',
    'client.welcome': 'Welcome, {company}',
    'client.order_tracking': 'Order Tracking',
    'client.document_label': 'Document',

    // Onboarding
    'onb.title': 'Corporate Onboarding',
    'onb.steps.company': 'Company',
    'onb.steps.hierarchy': 'Hierarchy',
    'onb.steps.roles': 'Roles',
    'onb.steps.budgets': 'Budgets',
    'onb.company_registration': 'Company Registration',
    'onb.company_name': 'Company Name',
    'onb.domain': 'Email Domain',
    'onb.hierarchy_setup': 'Hierarchy Setup',
    'onb.add_departments': 'Add departments for your organization',
    'onb.new_department': 'New Department',
    'onb.remove_last': 'Remove last',
    'onb.role_permissions': 'Role-based Permissions',
    'onb.select_roles': 'Select applicable roles',
    'onb.role_matrix': 'Permission Matrix',
    'onb.perm.create_pr': 'Create PRs',
    'onb.perm.approve_po': 'Approve POs',
    'onb.perm.manage_budgets': 'Manage Budgets',
    'onb.perm.view_finance': 'View Finance',
    'onb.department_budgets': 'Department Budgets',
    'onb.allocate_budgets': 'Allocate budgets per department',
    'onb.annual_budget': 'Annual Budget (IDR)',
    'onb.budget_allocation': 'Budget Allocation',
    'onb.total_budget': 'Total Budget',
    'onb.remaining': 'Remaining',
    'onb.finish': 'Finish',
    'onb.autosaved': 'Draft autosaved',
    'onb.err_over_budget': 'Allocated exceeds total budget',
    'onb.finish_success': 'Onboarding complete',

    // Document Manager
    'docs.title': 'Document Manager',
    'docs.list': 'Documents',
    'docs.bulk_download': 'Bulk Download',
    'docs.version': 'v{n}',
    'docs.access': 'Access',
    'docs.thumbnail': 'Thumbnail',
    'docs.delete_selected': 'Delete Selected',
    'docs.download': 'Download',
    'docs.selected': 'Selected: {n}',
    'docs.downloading': 'Downloading {n} files...',
    'docs.download_complete': 'Download complete',
    'docs.show_history': 'Show history',
    'docs.hide_history': 'Hide history',
    'docs.version_history': 'Version History',

    // Email Dashboard
    'email.title': 'Email Integration',
    'email.sync_status': 'Sync Status',
    'email.connected': 'Connected',
    'email.disconnected': 'Disconnected',
    'email.sync_desc': 'Two-way sync visualization between app and email. Configure CC/BCC rules per client type and manage templates.',
    'email.templates': 'Templates',
    'email.add_template': 'Add Template',
    'email.new_template': 'New Template',
    'email.name': 'Name',
    'email.subject': 'Subject',
    'email.updated': 'Updated',
    'email.rules': 'CC/BCC Rules',
    'email.client_type': 'Client Type',
    'email.cc': 'CC',
    'email.bcc': 'BCC',
    'email.enabled': 'Enabled',
    'email.toggle_enabled': 'Toggle',
    'email.save_rules': 'Save Rules',

    // Communication Hub
    'comms.title': 'Communication Hub',
    'comms.threads': 'Threads',
    'comms.unread': 'Unread: {n}',
    'comms.input_placeholder': 'Type a message. Use @mentions',
    'comms.to': 'To',
    'comms.cc': 'Cc',
    'comms.bcc': 'Bcc',
    'comms.subject': 'Subject',
    'comms.hint_mentions': 'Use @ to mention participants',
    'comms.email_integration': 'Email Integration',
    'comms.email_sync_desc': 'Two-way sync is visualized here. CC/BCC rules per client type are applied automatically.',
    'comms.connected_to': 'Connected to: {email}',
    'comms.add_attachments': 'Add attachments',
    'comms.attachments': 'Attachments',
    'comms.uploading': 'Uploading...',
    'comms.status.sent': 'Sent',
    'comms.status.delivered': 'Delivered',
    'comms.status.read': 'Read',
    'comms.blocked_banner': 'Messaging disabled: one or more participants are blocked.',

    // Reporting
    'reports.title': 'Reporting',
    'reports.spending_analytics': 'Spending Analytics',
    'reports.vendor_performance': 'Vendor Performance',
    'reports.budget_utilization': 'Budget Utilization',
    // Delivery Notes (Inventory)
    'delivery.title': 'Delivery Notes',
    'delivery.header_desc': 'Confirm receipts and record corrections; invoices must respect corrected quantities.',
    'delivery.po_label': 'PO',
    'delivery.delivered_amount': 'Delivered Amount',
    'delivery.table.item': 'Item',
    'delivery.table.ordered': 'Ordered',
    'delivery.table.shipped': 'Shipped',
    'delivery.table.received': 'Received',
    'delivery.table.correction': 'Correction',
    'delivery.table.available_to_invoice': 'Available to Invoice',
    'delivery.invariant': 'Invariant: sum(delivery.qty) ≤ sum(po.qty). Corrections adjust available-to-invoice quantities; invoices must respect corrected quantities.',
    'delivery.correction_aria': 'Correction for {name}',

    // Reporting (Supplier) — Invoicing Gate
    'reporting.create_invoice': 'Create Invoice',
    'reporting.remaining_deliverable': 'Remaining deliverable',
    'reporting.delivery_references': 'Delivery References',
    'reporting.no_delivery_records': 'No delivery records found for this PO.',
    'reporting.insufficient_delivered_amount': 'Insufficient delivered amount',
    // Reporting — Payment Status Labels
    'reporting.status.paid': 'Paid',
    'reporting.status.over_due': 'Over-due',
    'reporting.status.waiting': 'Waiting payment',
    'reporting.status.next': 'Next payment',
    'reporting.status.neutral': 'Neutral',
    'reports.monthly_procurement': 'Monthly Procurement',
    // Help Center
    'help.title': 'Help Center',
    'help.sub': 'Guides, workflows, and quick links',
    'help.user_guide': 'User Guide',
    'help.user_guide_desc': 'End-to-end walkthrough from PR to Paid.',
    'help.workflows': 'Workflows',
    'help.workflows_desc': 'Lifecycle, guards, and invariants.',
    'help.roles_permissions': 'Roles & Permissions',
    'help.roles_permissions_desc': 'Access matrix and approvals gating.',
    'help.ui_theme_i18n': 'UI Theme & I18N',
    'help.ui_theme_i18n_desc': 'Neon corporate palette and language behavior.',
    'help.faq': 'FAQ',
    'help.faq_desc': 'Common questions and answers.',
    'help.email': 'Email & Communication',
    'help.email_desc': 'Email integration and comms hub overview.',
    'help.reporting': 'Reporting',
    'help.reporting_desc': 'Spending analytics and exports.',
    'help.glossary': 'Glossary',
    'help.glossary_desc': 'Key terms and definitions.',
    'help.copy_en_path': 'Copy EN path',
    'help.copy_id_path': 'Copy ID path',
    'help.quick_actions': 'Quick Actions',
    'help.go_create_pr': 'Create PR',
    'help.go_quote_builder': 'Quote Builder',
    'help.go_po_preview': 'PO Preview',
    'help.go_order_tracker': 'Order Tracker',
    'help.go_reporting': 'Reporting',
    'help.docs_hint': 'Docs are included in the repository under /docs. Use the copy buttons to open them locally.',
    'help.openEnglish': 'Open (EN)',
    'help.openIndonesian': 'Open (ID)',
    'help.searchPlaceholder': 'Search help topics...',
    'help.featuredTopics': 'Featured Topics',
    'help.topicPOConversion': 'Convert Quote → PO',
    'help.topicInvoicing': 'Invoicing & Payments',
    'help.topicLifecycle': 'Procurement Lifecycle',
    'help.back': 'Back',
    'help.toggleLanguage': 'Toggle Language',
    'help.openAlternate': 'Open Alternate Language',
    'help.viewing': 'Viewing',
    'help.loading': 'Loading...',

    
    'order_tracker.title': 'Order Tracker',
    'order_tracker.estimated_delivery': 'Estimated delivery',
    'order_tracker.shipping_info': 'Shipping Information',
    'order_tracker.courier': 'Courier',
    'order_tracker.tracking_no': 'Tracking No',
    'order_tracker.delivery_proof': 'Delivery Proof',
    'order_tracker.drop_hint': 'Drag & drop files here or',
    'order_tracker.view_tracking': 'View tracking',
    'order_tracker.uploading': 'Uploading...',
    'order_tracker.upload_complete': 'Upload complete',
    'order_tracker.remove': 'Remove',
    'time.days': 'days',
    'time.hours': 'hours',
    'time.minutes': 'minutes',
    'action.upload': 'Upload',

    // Gating messages / actions
    'gating.quote_builder_disabled': 'Approve PRs and send to suppliers to build quotes',
    'gating.approval_required_send': 'Only Approved PRs can be sent to suppliers. Please get Finance/Admin approval first.',
    'gating.approval_required_compare': 'Approve PR to compare quotes.',
    'action.compare_quotes': 'Compare quotes',
    'action.send_pr_to_suppliers': 'Send PR to suppliers',
    'action.approve': 'Approve',
    'action.reject': 'Reject',

    // Quote actions & labels
    'action.approve_quote': 'Approve Quote',
    'action.reject_quote': 'Reject Quote',
    'po.generate_from_quote': 'Generate PO',
    'quote.version': 'Version',
    'quote.valid_until': 'Valid Until',
    'status.label': 'Status',
    'actions.label': 'Actions',
    'quotes.title': 'Quote Comparison',
    'quotes.subtitle': 'Compare quotes for PR {pr}',
    'quotes.none_hint': 'No quotes yet. Use "Send PR to suppliers" from PR List, then check back.',
    'quote.approved_alert': 'Approved quote v{version} from {supplier}. You can now generate a PO.',
    'quote.rejected_alert': 'Rejected quote v{version} from {supplier}.',

    // PR List / Create
    'pr.header': 'Purchase Requests',
    'pr.total': 'total',
    'pr.new_pr': 'New PR',
    'pr.id': 'PR ID',
    'pr.title_label': 'Title',
    'pr.department': 'Department',
    'pr.status': 'Status',
    'pr.created': 'Created',
    'pr.details': 'Request Details',
    'pr.items': 'Items',
    'pr.approval_budget': 'Approval & Budget',
    'pr.step_of': 'Step {n} of {max}',
    'pr.files_drop_hint': 'Drag & drop files here or select to upload',
    'pr.uploading': 'Uploading',
    'pr.done': 'Done',
    'pr.item_spec': 'Specification',
    'pr.budget_code': 'Budget Code',
    'pr.approver': 'Approver',
    'pr.autosaved': 'Draft autosaved',
    'pr.submit_success': 'PR submitted successfully',
    'pr.err_title': 'Title is required',
    'pr.err_department': 'Department is required',
    'pr.err_needed_by': 'Needed by date required',
    'pr.err_items': 'At least one item is required',
    'pr.err_item_name': 'Item name required',
    'pr.err_item_qty': 'Quantity must be > 0',
    'pr.err_budget_code': 'Budget code required',
    'pr.err_approver': 'Approver required',

    // Common form labels/actions
    'form.title': 'Title',
    'form.department': 'Department',
    'form.needed_by': 'Needed By',
    'form.description': 'Description',
    'form.attach_files': 'Attach files',
    'form.last_saved': 'Last saved: {time}',
    'action.back': 'Back',
    'action.continue': 'Continue',
    'action.submit_pr': 'Submit PR',
    'action.add_item': 'Add Item',
    'action.remove': 'Remove',
    'action.export': 'Export',
    'action.send': 'Send',

    // Quote Builder
    'quote.items': 'Items',
    'quote.item': 'Item',
    'quote.qty': 'Qty',
    'quote.price': 'Price',
    'quote.total': 'Total',
    'quote.tax_rate': 'Tax Rate (%)',
    'quote.discount': 'Discount (IDR)',
    'quote.template': 'Template',
    'quote.subtotal': 'Subtotal',
    'quote.tax': 'Tax',
    'quote.grand_total': 'Grand Total',
    'action.preview': 'Preview',
    'action.close_preview': 'Close Preview',
    'action.send_quote': 'Send Quote',
    'quote.preview_hint': 'This is a template preview. Content will match selected style.',
  },
  id: {
    // Auth / Login
    'auth.login_title': 'Masuk ke MPSOne',
    'auth.login_subtitle': 'Suite pengadaan enterprise untuk perusahaan tambang Kalimantan',
    'auth.email': 'Email',
    'auth.password': 'Kata Sandi',
    'auth.password_placeholder': 'Masukkan kata sandi',
    'auth.remember_me': 'Ingat saya',
    'auth.forgot_password': 'Lupa kata sandi?',
    'auth.role': 'Masuk sebagai',
    'auth.role_hint': 'Hak akses berbasis peran: Admin, PIC Operasional, PIC Procurement, PIC Finance',
    'auth.sign_in': 'Masuk',
    'auth.or': 'atau',
    'auth.sso': 'Masuk dengan SSO',
    'auth.sso_hint': 'Placeholder integrasi SSO (Azure AD / Google Workspace)',
    'auth.security_notice': 'Keamanan: WCAG AA, formulir aman, dan rute terlindungi',
    'auth.version': 'Versi {v}',
    'auth.login_success': 'Selamat datang {email}',
    'auth.error_email': 'Harap masukkan alamat email yang valid',
    'auth.error_password': 'Kata sandi minimal 6 karakter',
    'auth.choose_who': 'Anda siapa?',
    'auth.i_am_supplier': 'Saya Supplier',
    'auth.i_am_client': 'Saya Klien',
    'auth.role_explain': 'Supplier masuk sebagai Admin. Klien memilih peran PIC.',
    'auth.mode_supplier': 'Mode Supplier dipilih',
    'auth.mode_client': 'Mode Klien dipilih',
    'auth.supplier_admin_assumed': 'Akses Admin Supplier diasumsikan untuk lingkungan ini',
    'auth.use_code': 'Masuk dengan Kode',
    'auth.join_with_code_hint': 'Masukkan kode akses dari admin untuk konfigurasi otomatis akun Anda.',
    'auth.code_invalid': 'Kode tidak valid',
    'auth.code_success': 'Akses diberikan',
    'auth.code_number': 'Nomor kode',
    'auth.continue': 'Lanjut',
    'department.name': 'Departemen',
    'clipboard.copied': 'Disalin',

    // Role descriptions
    'roles.pic_operational_desc': 'Penerimaan harian, konfirmasi pengiriman, koreksi surat jalan.',
    'roles.pic_procurement_desc': 'Pembuatan PR, penawaran pemasok, pembuatan PO, koordinasi vendor.',
    'roles.pic_finance_desc': 'Verifikasi tagihan, penjadwalan pembayaran, pelacakan status pembayaran.',

    // Admin invites
    'admin.invite_user': 'Undang Pengguna',
    'admin.invites.title': 'Kelola Undangan',
    'admin.invites.none': 'Belum ada undangan.',
    'admin.invites.code': 'Kode',
    'admin.invites.expires_at': 'Kedaluwarsa',
    'admin.invites.status': 'Status',
    'admin.invites.revoke': 'Batalkan',
    // General
    'general.home': 'Beranda',

    // Navigation
    'nav.admin_dashboard': 'Dasbor Admin',
    'nav.client_dashboard': 'Dasbor Klien',
    'nav.onboarding': 'Onboarding Perusahaan',
    'nav.purchase_requests': 'Permintaan Pembelian',
    'nav.quote_builder': 'Pembuat Penawaran',
    'nav.order_tracker': 'Pelacak Pesanan',
    'nav.docs': 'Manajer Dokumen',
    'nav.comms': 'Pusat Komunikasi',
    'nav.email_dashboard': 'Dasbor Email',
    'nav.reporting': 'Laporan',
    'nav.help': 'Pusat Bantuan',
    'nav.people': 'Orang',
    'nav.invitations': 'Undangan',

    // Topbar
    'topbar.light': 'Terang',
    'topbar.dark': 'Gelap',
    'topbar.neon': 'Neon',
    'topbar.mode': 'Mode',
    'topbar.theme': 'Tema',
    'topbar.quick_search': 'Cari PR, PO, penawaran...',
    'topbar.notifications': 'Notifikasi',
    'topbar.unread': 'belum dibaca',
    'topbar.language': 'Bahasa',
    'topbar.lang.en': 'English',
    'topbar.lang.id': 'Bahasa Indonesia',
    'topbar.help': 'Bantuan',
    'topbar.theme_toggle': 'Ganti tema',
    'topbar.language_toggle': 'Ganti bahasa',
    'topbar.settings': 'Pengaturan',
    'topbar.logout': 'Keluar',
    'topbar.logged_in_as': 'Masuk sebagai {name}',
    'topbar.offline_mock': 'Mock Offline',

    // Admin Dashboard
    'admin.title': 'Dasbor Admin',
    'admin.metrics.pending_quotes': 'Penawaran Tertunda',
    'admin.metrics.active_pos': 'PO Aktif',
    'admin.metrics.unpaid_invoices': 'Tagihan Belum Dibayar',
    'admin.updated_hint': 'Diperbarui 10m lalu',
    'admin.comm_center': 'Pusat Komunikasi Klien',
    'admin.compose_email': 'Tulis Email',
    'admin.recent_activity': 'Aktivitas Terbaru',
    'admin.new_pr': 'PR Baru',
    'admin.new_quote': 'Penawaran Baru',
    'admin.new_po': 'PO Baru',

    // Activity strings
    'activity.created_quote': 'Membuat Penawaran {id} untuk {pr}',
    'activity.approved_po': 'Menyetujui {po}',
    'activity.updated_budget': 'Memperbarui anggaran untuk {dept}',

    // Time strings
    'time.today': 'Hari ini',
    'time.yesterday': 'Kemarin',
    'time.hours_ago': '{n}j lalu',
    'time.days_ago': '{n} hari lalu',
    'time.days': 'hari',

    // DataTable common
    'datatable.filter': 'Filter...',
    'datatable.export_csv': 'Ekspor CSV',
    'datatable.export_pdf': 'Ekspor PDF',
    'datatable.client_id': 'ID Klien',
    'datatable.company': 'Perusahaan',
    'datatable.status': 'Status',
    'datatable.last_contact': 'Kontak Terakhir',
    'datatable.bulk_action': 'Aksi Massal',
    'datatable.select_all': 'Pilih semua',
    'datatable.prev': 'Sebelumnya',
    'datatable.next': 'Berikutnya',
    'datatable.page': 'Halaman',

    // Status values
    'status.active': 'Aktif',
    'status.pending_quote': 'Menunggu Penawaran',
    'status.po_issued': 'PO Diterbitkan',
    'status.shipped': 'Dikirim',
    'status.unpaid': 'Belum Dibayar',
    'status.processing': 'Diproses',
    'status.delivered': 'Terkirim',
    'status.invoiced': 'Ditagihkan',
    'status.paid': 'Dibayar',
    'status.pr': 'PR',
    'status.quote': 'Penawaran',
    'status.po': 'PO',

    // Client Dashboard
    'client.quick_pr': 'PR Cepat',
    'client.quick_pr_desc': 'Buat PR hanya dengan beberapa klik.',
    'client.create_pr': 'Buat PR',
    'client.budget_utilization': 'Penggunaan Anggaran',
    'client.documents': 'Dokumen',
    'client.welcome': 'Selamat datang, {company}',
    'client.order_tracking': 'Pelacakan Pesanan',
    'client.document_label': 'Dokumen',

    // Onboarding
    'onb.title': 'Onboarding Perusahaan',
    'onb.steps.company': 'Perusahaan',
    'onb.steps.hierarchy': 'Hierarki',
    'onb.steps.roles': 'Peran',
    'onb.steps.budgets': 'Anggaran',
    'onb.company_registration': 'Registrasi Perusahaan',
    'onb.company_name': 'Nama Perusahaan',
    'onb.domain': 'Domain Email',
    'onb.hierarchy_setup': 'Pengaturan Hierarki',
    'onb.add_departments': 'Tambahkan departemen untuk organisasi Anda',
    'onb.new_department': 'Departemen Baru',
    'onb.remove_last': 'Hapus terakhir',
    'onb.role_permissions': 'Hak Akses Berbasis Peran',
    'onb.select_roles': 'Pilih peran yang berlaku',
    'onb.role_matrix': 'Matriks Hak Akses',
    'onb.perm.create_pr': 'Buat PR',
    'onb.perm.approve_po': 'Setujui PO',
    'onb.perm.manage_budgets': 'Kelola Anggaran',
    'onb.perm.view_finance': 'Lihat Keuangan',
    'onb.department_budgets': 'Anggaran Departemen',
    'onb.allocate_budgets': 'Alokasikan anggaran per departemen',
    'onb.annual_budget': 'Anggaran Tahunan (IDR)',
    'onb.budget_allocation': 'Alokasi Anggaran',
    'onb.total_budget': 'Total Anggaran',
    'onb.remaining': 'Sisa',
    'onb.finish': 'Selesai',
    'onb.autosaved': 'Draf tersimpan otomatis',
    'onb.err_over_budget': 'Alokasi melebihi total anggaran',
    'onb.finish_success': 'Onboarding selesai',

    // Document Manager
    'docs.title': 'Manajer Dokumen',
    'docs.list': 'Dokumen',
    'docs.bulk_download': 'Unduh Massal',
    'docs.version': 'v{n}',
    'docs.access': 'Akses',
    'docs.thumbnail': 'Gambar mini',
    'docs.delete_selected': 'Hapus Terpilih',
    'docs.download': 'Unduh',
    'docs.selected': 'Terpilih: {n}',
    'docs.downloading': 'Mengunduh {n} berkas...',
    'docs.download_complete': 'Unduh selesai',
    'docs.show_history': 'Tampilkan riwayat',
    'docs.hide_history': 'Sembunyikan riwayat',
    'docs.version_history': 'Riwayat Versi',

    // Email Dashboard
    'email.title': 'Integrasi Email',
    'email.sync_status': 'Status Sinkronisasi',
    'email.connected': 'Terhubung',
    'email.disconnected': 'Tidak Terhubung',
    'email.sync_desc': 'Visualisasi sinkronisasi dua-arah antara aplikasi dan email. Atur CC/BCC per tipe klien dan kelola templat.',
    'email.templates': 'Templat',
    'email.add_template': 'Tambah Templat',
    'email.new_template': 'Templat Baru',
    'email.name': 'Nama',
    'email.subject': 'Subjek',
    'email.updated': 'Diperbarui',
    'email.rules': 'Aturan CC/BCC',
    'email.client_type': 'Tipe Klien',
    'email.cc': 'CC',
    'email.bcc': 'BCC',
    'email.enabled': 'Aktif',
    'email.toggle_enabled': 'Ubah',
    'email.save_rules': 'Simpan Aturan',

    // Communication Hub
    'comms.title': 'Pusat Komunikasi',
    'comms.threads': 'Thread',
    'comms.unread': 'Belum dibaca: {n}',
    'comms.input_placeholder': 'Ketik pesan. Gunakan @mention',
    'comms.to': 'Kepada',
    'comms.cc': 'Cc',
    'comms.bcc': 'Bcc',
    'comms.subject': 'Subjek',
    'comms.hint_mentions': 'Gunakan @ untuk menyebut peserta',
    'comms.email_integration': 'Integrasi Email',
    'comms.email_sync_desc': 'Sinkronisasi dua-arah divisualisasikan di sini. Aturan CC/BCC per tipe klien diterapkan otomatis.',
    'comms.connected_to': 'Terhubung ke: {email}',
    'comms.add_attachments': 'Tambah lampiran',
    'comms.attachments': 'Lampiran',
    'comms.uploading': 'Mengunggah...',
    'comms.status.sent': 'Terkirim',
    'comms.status.delivered': 'Tersampaikan',
    'comms.status.read': 'Dibaca',
    'comms.blocked_banner': 'Mengirim pesan dinonaktifkan: satu atau lebih peserta diblokir.',

    // Reporting
    'reports.title': 'Laporan',
    'reports.spending_analytics': 'Analitik Pengeluaran',
    'reports.vendor_performance': 'Performa Vendor',
    'reports.budget_utilization': 'Pemanfaatan Anggaran',
    'reports.monthly_procurement': 'Pengadaan Bulanan',
    // Catatan Pengiriman (Inventory)
    'delivery.title': 'Catatan Pengiriman',
    'delivery.header_desc': 'Konfirmasi penerimaan dan catat koreksi; faktur harus mengikuti jumlah yang telah dikoreksi.',
    'delivery.po_label': 'PO',
    'delivery.delivered_amount': 'Jumlah Terkirim',
    'delivery.table.item': 'Item',
    'delivery.table.ordered': 'Dipesan',
    'delivery.table.shipped': 'Dikirim',
    'delivery.table.received': 'Diterima',
    'delivery.table.correction': 'Koreksi',
    'delivery.table.available_to_invoice': 'Tersedia untuk Penagihan',
    'delivery.invariant': 'Invariant: jumlah(qty pengiriman) ≤ jumlah(qty PO). Koreksi menyesuaikan jumlah tersedia untuk penagihan; faktur harus mengikuti jumlah yang dikoreksi.',
    'delivery.correction_aria': 'Koreksi untuk {name}',

    // Pelaporan (Supplier) — Gerbang Penagihan
    'reporting.create_invoice': 'Buat Faktur',
    'reporting.remaining_deliverable': 'Sisa yang dapat ditagihkan',
    'reporting.delivery_references': 'Referensi Pengiriman',
    'reporting.no_delivery_records': 'Tidak ada catatan pengiriman untuk PO ini.',
    'reporting.insufficient_delivered_amount': 'Jumlah terkirim tidak mencukupi',
    // Pelaporan — Label Status Pembayaran
    'reporting.status.paid': 'Dibayar',
    'reporting.status.over_due': 'Terlambat',
    'reporting.status.waiting': 'Menunggu pembayaran',
    'reporting.status.next': 'Pembayaran berikutnya',
    'reporting.status.neutral': 'Netral',
    // Help Center
    'help.title': 'Pusat Bantuan',
    'help.sub': 'Panduan, alur kerja, dan tautan cepat',
    'help.user_guide': 'Panduan Pengguna',
    'help.user_guide_desc': 'Langkah lengkap dari PR hingga Paid.',
    'help.workflows': 'Alur Kerja',
    'help.workflows_desc': 'Lifecycle, penjaga, dan invariants.',
    'help.roles_permissions': 'Peran & Hak Akses',
    'help.roles_permissions_desc': 'Matriks akses dan persetujuan.',
    'help.ui_theme_i18n': 'Tema UI & I18N',
    'help.ui_theme_i18n_desc': 'Palet neon korporat dan perilaku bahasa.',
    'help.faq': 'FAQ',
    'help.faq_desc': 'Pertanyaan umum dan jawaban.',
    'help.email': 'Email & Komunikasi',
    'help.email_desc': 'Integrasi email dan ringkasan pusat komunikasi.',
    'help.reporting': 'Pelaporan',
    'help.reporting_desc': 'Analitik pengeluaran dan ekspor.',
    'help.glossary': 'Glosarium',
    'help.glossary_desc': 'Istilah kunci dan definisi.',
    'help.copy_en_path': 'Salin path EN',
    'help.copy_id_path': 'Salin path ID',
    'help.quick_actions': 'Tindakan Cepat',
    'help.go_create_pr': 'Buat PR',
    'help.go_quote_builder': 'Pembuat Penawaran',
    'help.go_po_preview': 'Pratinjau PO',
    'help.go_order_tracker': 'Pelacak Pesanan',
    'help.go_reporting': 'Laporan',
    'help.docs_hint': 'Dokumen ada di repositori bawah /docs. Gunakan tombol salin untuk membukanya secara lokal.',
    'help.openEnglish': 'Buka (EN)',
    'help.openIndonesian': 'Buka (ID)',
    'help.searchPlaceholder': 'Cari topik bantuan...',
    'help.featuredTopics': 'Topik Unggulan',
    'help.topicPOConversion': 'Konversi Quote → PO',
    'help.topicInvoicing': 'Penagihan & Pembayaran',
    'help.topicLifecycle': 'Lifecycle Pengadaan',
    'help.back': 'Kembali',
    'help.toggleLanguage': 'Ganti Bahasa',
    'help.openAlternate': 'Buka Bahasa Alternatif',
    'help.viewing': 'Melihat',
    'help.loading': 'Memuat...',

    
    'order_tracker.title': 'Pelacak Pesanan',
    'order_tracker.estimated_delivery': 'Perkiraan pengiriman',
    'order_tracker.shipping_info': 'Informasi Pengiriman',
    'order_tracker.courier': 'Kurir',
    'order_tracker.tracking_no': 'No Pelacakan',
    'order_tracker.delivery_proof': 'Bukti Pengiriman',
    'order_tracker.drop_hint': 'Tarik & letakkan berkas di sini atau',
    'order_tracker.view_tracking': 'Lihat pelacakan',
    'order_tracker.uploading': 'Mengunggah...',
    'order_tracker.upload_complete': 'Unggah selesai',
    'order_tracker.remove': 'Hapus',
    'time.hours': 'jam',
    'time.minutes': 'menit',

    // PR List / Create
    'pr.header': 'Permintaan Pembelian',
    'pr.total': 'total',
    'pr.new_pr': 'PR Baru',
    'pr.id': 'ID PR',
    'pr.title_label': 'Judul',
    'pr.department': 'Departemen',
    'pr.status': 'Status',
    'pr.created': 'Dibuat',
    'pr.details': 'Detail Permintaan',
    'pr.items': 'Item',
    'pr.approval_budget': 'Persetujuan & Anggaran',
    'pr.step_of': 'Langkah {n} dari {max}',
    'pr.files_drop_hint': 'Tarik & letakkan berkas di sini atau pilih untuk unggah',
    'pr.uploading': 'Mengunggah',
    'pr.done': 'Selesai',
    'pr.item_spec': 'Spesifikasi',
    'pr.budget_code': 'Kode Anggaran',
    'pr.approver': 'Penyetuju',
    'pr.autosaved': 'Draf tersimpan otomatis',
    'pr.submit_success': 'PR berhasil dikirim',
    'pr.err_title': 'Judul wajib diisi',
    'pr.err_department': 'Departemen wajib diisi',
    'pr.err_needed_by': 'Tanggal dibutuhkan wajib diisi',
    'pr.err_items': 'Minimal satu item wajib ada',
    'pr.err_item_name': 'Nama item wajib diisi',
    'pr.err_item_qty': 'Jumlah harus > 0',
    'pr.err_budget_code': 'Kode anggaran wajib diisi',
    'pr.err_approver': 'Penyetuju wajib diisi',

    // Common form labels/actions
    'form.title': 'Judul',
    'form.department': 'Departemen',
    'form.needed_by': 'Dibutuhkan Pada',
    'form.description': 'Deskripsi',
    'form.attach_files': 'Lampirkan berkas',
    'form.last_saved': 'Terakhir disimpan: {time}',
    'action.back': 'Kembali',
    'action.continue': 'Lanjut',
    'action.submit_pr': 'Kirim PR',
    'action.add_item': 'Tambah Item',
    'action.remove': 'Hapus',
    'action.export': 'Ekspor',
    'action.send': 'Kirim',

    // Quote Builder
    'quote.items': 'Item',
    'quote.item': 'Item',
    'quote.qty': 'Qty',
    'quote.price': 'Harga',
    'quote.total': 'Total',
    'quote.tax_rate': 'Pajak (%)',
    'quote.discount': 'Diskon (IDR)',
    'quote.template': 'Templat',
    'quote.subtotal': 'Subtotal',
    'quote.tax': 'Pajak',
    'quote.grand_total': 'Total Akhir',
    'action.preview': 'Pratinjau',
    'action.close_preview': 'Tutup Pratinjau',
    'action.send_quote': 'Kirim Penawaran',
    'quote.preview_hint': 'Ini adalah pratinjau templat. Konten akan mengikuti gaya terpilih.',
    // Gating messages / actions
    'gating.quote_builder_disabled': 'Setujui PR dan kirim ke pemasok untuk menyusun penawaran',
    'gating.approval_required_send': 'Hanya PR Disetujui yang bisa dikirim ke pemasok. Mohon minta persetujuan Finance/Admin terlebih dahulu.',
    'gating.approval_required_compare': 'Setujui PR untuk membandingkan penawaran.',
    'action.compare_quotes': 'Bandingkan penawaran',
    'action.send_pr_to_suppliers': 'Kirim PR ke pemasok',
    'action.approve': 'Setujui',
    'action.reject': 'Tolak',
  },
};

const I18nContext = createContext<I18nContextValue | undefined>(undefined);

function detectDefaultLanguage(): Language {
  const legacy = localStorage.getItem('lang') as Language | null;
  const stored = localStorage.getItem('mpsone_lang') as Language | null;
  const pref = stored ?? legacy;
  if (pref === 'en' || pref === 'id') return pref;
  const nav = navigator?.language?.toLowerCase() ?? 'en';
  if (nav.startsWith('id')) return 'id';
  return 'en';
}

export function I18nProvider({ children }: { children: React.ReactNode }) {
  const [language, setLanguage] = useState<Language>(detectDefaultLanguage());

  useEffect(() => {
    // Persist both legacy and new keys
    localStorage.setItem('lang', language);
    setPreferredLanguage(language);
  }, [language]);

  // Keep <html lang> aligned with current language for accessibility (WCAG)
  useEffect(() => {
    try {
      const html = document.documentElement;
      const langCode = language === 'id' ? 'id' : 'en';
      html.setAttribute('lang', langCode);
      // Explicitly set direction for clarity; both EN and ID are LTR
      html.setAttribute('dir', 'ltr');
    } catch {}
  }, [language]);

  // On first load, if no stored preference, hint language using IP geo (free, cached)
  useEffect(() => {
    const hasStored = !!(localStorage.getItem('mpsone_lang') || localStorage.getItem('lang'));
    if (hasStored) return;
    let cancelled = false;
    (async () => {
      try {
        const geo = await getGeoInfo();
        const next = getPreferredLanguage(geo.country);
        if (!cancelled) setLanguage(next);
      } catch {}
    })();
    return () => { cancelled = true; };
  }, []);

  const t = useMemo(() => {
    return (key: string) => {
      const table = translations[language];
      return table[key] ?? translations.en[key] ?? key;
    };
  }, [language]);

  const value: I18nContextValue = { language, setLanguage, t };
  return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>;
}

export function useI18n(): I18nContextValue {
  const ctx = useContext(I18nContext);
  if (!ctx) throw new Error('useI18n must be used within I18nProvider');
  return ctx;
}
